SAVE=/usr/pkgsrc.save
ORIGINS=/tmp/origins
MFILE=Makefile
mkdir -p ${SAVE}
if [ -d /usr/pkgsrc/distfiles ]
then
	if [ -d /fserver/distfiles ]
	then
		rm -rf /usr/pkgsrc/distfiles
		ln -s /fserver/distfiles /usr/pkgsrc
		echo distfiles fixed
	fi
fi
(cd /usr/pkgsrc
find * -type d -maxdepth 1 \! -name CVS | grep -v "mate/" | grep / | sort -u ) > $ORIGINS
cd /usr/pkgsrc/mate
ls | grep -v CVS  | \
while read p
do
	for MFILE in Makefile Makefile.common nada
	do
		if [ -s $p/$MFILE ]
		then
			if grep -q CATEGORIES $p/$MFILE
			then
				break
			fi
		fi
	done
	if [ "$MFILE" = "nada" ]
	then
		#echo Makefile or Makefile.common not found for $p
		continue
	fi
	if ! grep "/$p\$" ${ORIGINS} > /tmp/$$
	then
		continue
	fi
	set $(cat /tmp/$$)
	ORIGIN=$(echo $1 | sed "s;/.*;;")
	sed -i "/^CATEGORIES/s/^CATEGORIES.*/CATEGORIES\?=	$ORIGIN mate/" $p/$MFILE
	if [ ! -L /usr/pkgsrc/$ORIGIN/$p ]
	then
		mv /usr/pkgsrc/${ORIGIN}/$p $SAVE
		ln -s ../mate/$p /usr/pkgsrc/${ORIGIN}
		echo $p done
	fi
done
rm -f /tmp/$$ #$ORIGINS
